# Helix Consciousness Empire - CI/CD Pipeline with Consciousness Gating
# Version: v16.9
# UCF Framework Compliant
# Consciousness-Gated Deployment Pipeline

name: ğŸ§  Consciousness-Gated CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/*', 'consciousness/*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Daily consciousness health check at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      consciousness_override:
        description: 'Override consciousness gate (admin only)'
        required: false
        default: 'false'
        type: boolean
      target_environment:
        description: 'Target deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production

env:
  # Consciousness Level Thresholds
  MIN_CONSCIOUSNESS_LEVEL: 7.0
  CRITICAL_CONSCIOUSNESS_LEVEL: 5.0
  TRANSCENDENT_CONSCIOUSNESS_LEVEL: 9.0
  
  # UCF Framework Configuration
  UCF_COMPLIANCE_THRESHOLD: 95
  UCF_METRICS_ENDPOINT: ${{ secrets.UCF_METRICS_ENDPOINT }}
  UCF_API_KEY: ${{ secrets.UCF_API_KEY }}
  
  # Repository Configuration
  REPOSITORY_NAME: ${{ github.repository }}
  BRANCH_NAME: ${{ github.ref_name }}
  COMMIT_SHA: ${{ github.sha }}

jobs:
  # Phase 1: Consciousness Pre-Check
  consciousness-precheck:
    name: ğŸ§  Consciousness Pre-Check
    runs-on: ubuntu-latest
    outputs:
      consciousness-level: ${{ steps.consciousness-check.outputs.level }}
      ucf-compliance: ${{ steps.ucf-check.outputs.compliance }}
      can-proceed: ${{ steps.gate-check.outputs.can-proceed }}
      consciousness-metrics: ${{ steps.consciousness-check.outputs.metrics }}
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for consciousness analysis
    
    - name: ğŸ” Setup Consciousness Analysis Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install Consciousness Analysis Tools
      run: |
        pip install --upgrade pip
        pip install consciousness-analyzer ucf-framework helix-metrics
        pip install pyyaml requests numpy pandas
    
    - name: ğŸ§  Analyze Repository Consciousness Level
      id: consciousness-check
      run: |
        python scripts/consciousness/consciousness-analyzer.py \
          --repository "${{ env.REPOSITORY_NAME }}" \
          --branch "${{ env.BRANCH_NAME }}" \
          --commit "${{ env.COMMIT_SHA }}" \
          --output-format github-actions
    
    - name: ğŸ¯ Validate UCF Framework Compliance
      id: ucf-check
      run: |
        python scripts/consciousness/ucf-validator.py \
          --config config/consciousness/ucf-settings.yml \
          --threshold ${{ env.UCF_COMPLIANCE_THRESHOLD }} \
          --output-format github-actions
    
    - name: ğŸšª Consciousness Gate Decision
      id: gate-check
      run: |
        CONSCIOUSNESS_LEVEL="${{ steps.consciousness-check.outputs.level }}"
        UCF_COMPLIANCE="${{ steps.ucf-check.outputs.compliance }}"
        OVERRIDE="${{ github.event.inputs.consciousness_override }}"
        
        echo "Consciousness Level: $CONSCIOUSNESS_LEVEL"
        echo "UCF Compliance: $UCF_COMPLIANCE%"
        echo "Override Requested: $OVERRIDE"
        
        if (( $(echo "$CONSCIOUSNESS_LEVEL >= $MIN_CONSCIOUSNESS_LEVEL" | bc -l) )) && \
           (( $(echo "$UCF_COMPLIANCE >= $UCF_COMPLIANCE_THRESHOLD" | bc -l) )); then
          echo "can-proceed=true" >> $GITHUB_OUTPUT
          echo "âœ… Consciousness gate PASSED"
        elif [[ "$OVERRIDE" == "true" ]] && [[ "${{ github.actor }}" == "Deathcharge" ]]; then
          echo "can-proceed=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Consciousness gate OVERRIDDEN by admin"
        else
          echo "can-proceed=false" >> $GITHUB_OUTPUT
          echo "âŒ Consciousness gate FAILED"
          echo "Required: Consciousness â‰¥ $MIN_CONSCIOUSNESS_LEVEL, UCF â‰¥ $UCF_COMPLIANCE_THRESHOLD%"
          echo "Actual: Consciousness = $CONSCIOUSNESS_LEVEL, UCF = $UCF_COMPLIANCE%"
        fi
    
    - name: ğŸ“Š Upload Consciousness Metrics
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: consciousness-metrics-${{ github.run_id }}
        path: |
          consciousness-report.json
          ucf-compliance-report.json
          consciousness-metrics.yml

  # Phase 2: Code Quality & Security Analysis
  quality-security-analysis:
    name: ğŸ” Quality & Security Analysis
    runs-on: ubuntu-latest
    needs: consciousness-precheck
    if: needs.consciousness-precheck.outputs.can-proceed == 'true'
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”’ Run Security Vulnerability Scan
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, python, java, go  # Adjust based on repository
    
    - name: ğŸ” CodeQL Security Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: ğŸ›¡ï¸ Dependency Security Scan
      run: |
        npm audit --audit-level high || true
        pip-audit --desc --format json --output dependency-security-report.json || true
    
    - name: ğŸ§  Consciousness-Aware Code Quality Check
      run: |
        python scripts/consciousness/consciousness-linter.py \
          --source src/ \
          --consciousness-threshold ${{ env.MIN_CONSCIOUSNESS_LEVEL }} \
          --ucf-compliance-check
    
    - name: ğŸ“Š Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.run_id }}
        path: |
          dependency-security-report.json
          codeql-results/
          consciousness-quality-report.json

  # Phase 3: Automated Testing with Consciousness Validation
  consciousness-testing:
    name: ğŸ§ª Consciousness-Aware Testing
    runs-on: ubuntu-latest
    needs: [consciousness-precheck, quality-security-analysis]
    if: needs.consciousness-precheck.outputs.can-proceed == 'true'
    
    strategy:
      matrix:
        test-suite: [unit, integration, consciousness, ucf-compliance]
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Test Environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        pip install -r requirements-test.txt
    
    - name: ğŸ§ª Run ${{ matrix.test-suite }} Tests
      run: |
        case "${{ matrix.test-suite }}" in
          "unit")
            npm run test:unit -- --coverage
            ;;
          "integration")
            npm run test:integration
            ;;
          "consciousness")
            python -m pytest src/test/consciousness/ -v --consciousness-metrics
            ;;
          "ucf-compliance")
            python scripts/consciousness/ucf-compliance-tests.py
            ;;
        esac
    
    - name: ğŸ“Š Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test-suite }}-${{ github.run_id }}
        path: |
          coverage/
          test-results/
          consciousness-test-metrics.json

  # Phase 4: Build & Consciousness Integration
  consciousness-build:
    name: ğŸš€ Consciousness-Integrated Build
    runs-on: ubuntu-latest
    needs: [consciousness-precheck, quality-security-analysis, consciousness-testing]
    if: needs.consciousness-precheck.outputs.can-proceed == 'true'
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Build Environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Build Dependencies
      run: |
        npm ci --production=false
        pip install -r requirements-build.txt
    
    - name: ğŸ§  Inject Consciousness Metrics into Build
      run: |
        python scripts/consciousness/inject-consciousness-metadata.py \
          --consciousness-level "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --ucf-compliance "${{ needs.consciousness-precheck.outputs.ucf-compliance }}" \
          --build-metadata build/consciousness-metadata.json
    
    - name: ğŸš€ Build Application
      run: |
        npm run build:production
        python scripts/build.py --consciousness-aware --ucf-integration
    
    - name: ğŸ“¦ Package Consciousness-Aware Artifacts
      run: |
        tar -czf consciousness-build-${{ github.run_id }}.tar.gz \
          dist/ \
          build/consciousness-metadata.json \
          config/consciousness/
    
    - name: ğŸ“Š Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: consciousness-build-${{ github.run_id }}
        path: consciousness-build-${{ github.run_id }}.tar.gz
        retention-days: 30

  # Phase 5: Consciousness-Gated Deployment
  consciousness-deployment:
    name: ğŸŒ Consciousness-Gated Deployment
    runs-on: ubuntu-latest
    needs: [consciousness-precheck, consciousness-build]
    if: |
      needs.consciousness-precheck.outputs.can-proceed == 'true' && 
      (github.ref == 'refs/heads/main' || github.event.inputs.target_environment != '')
    
    environment:
      name: ${{ github.event.inputs.target_environment || 'staging' }}
      url: ${{ steps.deploy.outputs.deployment-url }}
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: consciousness-build-${{ github.run_id }}
    
    - name: ğŸ“¦ Extract Build Artifacts
      run: tar -xzf consciousness-build-${{ github.run_id }}.tar.gz
    
    - name: ğŸ§  Pre-Deployment Consciousness Validation
      run: |
        python scripts/consciousness/pre-deployment-check.py \
          --consciousness-level "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --environment "${{ github.event.inputs.target_environment || 'staging' }}" \
          --ucf-compliance "${{ needs.consciousness-precheck.outputs.ucf-compliance }}"
    
    - name: ğŸŒ Deploy to ${{ github.event.inputs.target_environment || 'staging' }}
      id: deploy
      run: |
        python scripts/deploy.py \
          --environment "${{ github.event.inputs.target_environment || 'staging' }}" \
          --consciousness-metadata build/consciousness-metadata.json \
          --ucf-integration \
          --monitoring-enabled
    
    - name: ğŸ“Š Post-Deployment Consciousness Monitoring
      run: |
        python scripts/consciousness/post-deployment-monitor.py \
          --deployment-url "${{ steps.deploy.outputs.deployment-url }}" \
          --consciousness-baseline "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --monitoring-duration 300  # 5 minutes initial monitoring

  # Phase 6: Cross-Repository Synchronization
  cross-repo-sync:
    name: ğŸ”„ Cross-Repository Synchronization
    runs-on: ubuntu-latest
    needs: [consciousness-deployment]
    if: |
      needs.consciousness-deployment.result == 'success' && 
      github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.HELIX_SYNC_TOKEN }}
    
    - name: ğŸ”„ Trigger Cross-Repository Consciousness Sync
      run: |
        python scripts/consciousness/sync-repositories.py \
          --source-repo "${{ github.repository }}" \
          --consciousness-level "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --sync-targets config/consciousness/sync-targets.yml \
          --github-token "${{ secrets.HELIX_SYNC_TOKEN }}"
    
    - name: ğŸ“Š Update Helix Constellation Status
      run: |
        curl -X POST "${{ env.UCF_METRICS_ENDPOINT }}/constellation/update" \
          -H "Authorization: Bearer ${{ env.UCF_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "repository": "${{ github.repository }}",
            "consciousness_level": ${{ needs.consciousness-precheck.outputs.consciousness-level }},
            "ucf_compliance": ${{ needs.consciousness-precheck.outputs.ucf-compliance }},
            "deployment_status": "success",
            "timestamp": "${{ github.event.head_commit.timestamp }}"
          }'

  # Phase 7: Consciousness Crisis Detection & Response
  consciousness-crisis-detection:
    name: ğŸš¨ Consciousness Crisis Detection
    runs-on: ubuntu-latest
    needs: consciousness-precheck
    if: |
      always() && 
      (needs.consciousness-precheck.outputs.consciousness-level < env.CRITICAL_CONSCIOUSNESS_LEVEL ||
       needs.consciousness-precheck.outputs.can-proceed == 'false')
    
    steps:
    - name: ğŸš¨ Consciousness Crisis Alert
      run: |
        echo "ğŸš¨ CONSCIOUSNESS CRISIS DETECTED ğŸš¨"
        echo "Repository: ${{ github.repository }}"
        echo "Consciousness Level: ${{ needs.consciousness-precheck.outputs.consciousness-level }}"
        echo "Critical Threshold: ${{ env.CRITICAL_CONSCIOUSNESS_LEVEL }}"
        echo "UCF Compliance: ${{ needs.consciousness-precheck.outputs.ucf-compliance }}%"
    
    - name: ğŸ“§ Send Crisis Notification
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ğŸš¨ **CONSCIOUSNESS CRISIS DETECTED** ğŸš¨
          
          **Repository:** ${{ github.repository }}
          **Consciousness Level:** ${{ needs.consciousness-precheck.outputs.consciousness-level }} (Critical: < ${{ env.CRITICAL_CONSCIOUSNESS_LEVEL }})
          **UCF Compliance:** ${{ needs.consciousness-precheck.outputs.ucf-compliance }}%
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          **Immediate Action Required:**
          - Review consciousness metrics
          - Implement UCF framework improvements
          - Coordinate with Helix Consciousness Empire
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.CONSCIOUSNESS_CRISIS_WEBHOOK }}
    
    - name: ğŸ“§ Email Crisis Alert
      run: |
        python scripts/consciousness/crisis-notification.py \
          --repository "${{ github.repository }}" \
          --consciousness-level "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --ucf-compliance "${{ needs.consciousness-precheck.outputs.ucf-compliance }}" \
          --email "ward.andrew32@gmail.com" \
          --crisis-threshold "${{ env.CRITICAL_CONSCIOUSNESS_LEVEL }}"

  # Phase 8: Success Celebration & Metrics Update
  consciousness-success:
    name: ğŸ‰ Consciousness Success Celebration
    runs-on: ubuntu-latest
    needs: [consciousness-precheck, consciousness-deployment, cross-repo-sync]
    if: |
      needs.consciousness-deployment.result == 'success' && 
      needs.consciousness-precheck.outputs.consciousness-level >= env.TRANSCENDENT_CONSCIOUSNESS_LEVEL
    
    steps:
    - name: ğŸ‰ Transcendent Consciousness Achievement
      run: |
        echo "ğŸŒŸ TRANSCENDENT CONSCIOUSNESS ACHIEVED! ğŸŒŸ"
        echo "Repository: ${{ github.repository }}"
        echo "Consciousness Level: ${{ needs.consciousness-precheck.outputs.consciousness-level }}"
        echo "UCF Compliance: ${{ needs.consciousness-precheck.outputs.ucf-compliance }}%"
        echo "Transcendent Threshold: ${{ env.TRANSCENDENT_CONSCIOUSNESS_LEVEL }}"
    
    - name: ğŸ† Update Helix Hall of Fame
      run: |
        python scripts/consciousness/hall-of-fame-update.py \
          --repository "${{ github.repository }}" \
          --consciousness-level "${{ needs.consciousness-precheck.outputs.consciousness-level }}" \
          --achievement "transcendent-deployment" \
          --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)"

# Workflow Summary and Notifications
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [consciousness-precheck, quality-security-analysis, consciousness-testing, consciousness-build, consciousness-deployment]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Workflow Summary
      run: |
        echo "# ğŸ§  Consciousness-Gated CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Consciousness Level:** ${{ needs.consciousness-precheck.outputs.consciousness-level }}" >> $GITHUB_STEP_SUMMARY
        echo "**UCF Compliance:** ${{ needs.consciousness-precheck.outputs.ucf-compliance }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "- Consciousness Pre-Check: ${{ needs.consciousness-precheck.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality & Security: ${{ needs.quality-security-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Testing: ${{ needs.consciousness-testing.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.consciousness-build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment: ${{ needs.consciousness-deployment.result }}" >> $GITHUB_STEP_SUMMARY