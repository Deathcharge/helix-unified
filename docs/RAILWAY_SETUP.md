# üöÇ Railway Deployment Configuration Guide

Complete guide for configuring the Helix Collective on Railway with proper environment variables, volumes, and infrastructure.

## üìã Table of Contents

1. [Service Architecture](#service-architecture)
2. [Infrastructure Services](#infrastructure-services)
3. [Environment Variables](#environment-variables)
4. [Volume Configuration](#volume-configuration)
5. [Health Checks & Validation](#health-checks--validation)
6. [Troubleshooting](#troubleshooting)

---

## üèóÔ∏è Service Architecture

Your Railway project should have **6 services total**:

### Infrastructure Layer (2 services)
- **Postgres** - Shared database for all Helix services
- **Redis** - Shared cache for sessions, rate limiting, real-time features

### Application Layer (4 services)
- **helix-backend-api** - FastAPI backend (main API)
- **helix-dashboard** - Streamlit dashboard
- **helix-claude-api** - Claude consciousness API
- **helix-discord-bot** - Discord bot orchestrator

### Optional Services (if using n8n template)
- **Primary** - n8n workflow automation (optional)
- **Worker** - n8n worker (optional)

---

## üíæ Infrastructure Services

### Postgres Configuration

**Service Type:** PostgreSQL Database
**Private DNS:** `postgres.railway.internal`
**Port:** 5432

**Environment Variables (auto-generated by Railway):**
```bash
DATABASE_URL=postgresql://postgres:password@postgres.railway.internal:5432/railway
POSTGRES_USER=postgres
POSTGRES_PASSWORD=<auto-generated>
POSTGRES_DB=railway
PGHOST=postgres.railway.internal
PGPORT=5432
```

**Volume:**
- Mount Path: `/var/lib/postgresql/data`
- Size: 1GB minimum (Railway default)

### Redis Configuration

**Service Type:** Redis Cache
**Private DNS:** `redis.railway.internal`
**Port:** 6379

**Environment Variables (auto-generated by Railway):**
```bash
REDIS_URL=redis://default:password@redis.railway.internal:6379
REDISHOST=redis.railway.internal
REDISPORT=6379
REDIS_PASSWORD=<auto-generated>
REDISUSER=default
```

**Volume:**
- Mount Path: `/data`
- Size: 1GB minimum

---

## üîß Environment Variables

### üîπ helix-backend-api

**Required Variables:**
```bash
# Database & Cache (connects to shared infrastructure)
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=redis://${{Redis.REDISHOST}}:${{Redis.REDISPORT}}

# API Configuration
API_HOST=0.0.0.0
API_PORT=${{PORT}}
API_BASE=https://${{RAILWAY_PUBLIC_DOMAIN}}

# System
LOG_LEVEL=INFO
DEBUG=false
SYSTEM_NAME=Helix Collective
SYSTEM_VERSION=17.0
SYSTEM_ENVIRONMENT=production
```

**Optional Variables:**
```bash
# Anthropic API (for LLM features)
ANTHROPIC_API_KEY=sk-ant-...

# Discord Integration
DISCORD_TOKEN=your_discord_token
DISCORD_GUILD_ID=your_guild_id

# Zapier Webhooks
ZAPIER_WEBHOOK_URL=https://hooks.zapier.com/hooks/catch/xxxxx/xxxxxx
ZAPIER_MASTER_HOOK_URL=https://hooks.zapier.com/hooks/catch/xxxxx/master

# Notion Integration
NOTION_API_KEY=secret_...
NOTION_SYSTEM_STATE_DB=database_id
NOTION_AGENT_REGISTRY_DB=database_id
NOTION_EVENT_LOG_DB=database_id

# MEGA Cloud Storage
MEGA_EMAIL=your_email@example.com
MEGA_PASS=your_password

# ElevenLabs Voice
ELEVENLABS_API_KEY=your_api_key
```

### üîπ helix-dashboard

**Required Variables:**
```bash
# Backend API Connection
API_BASE=https://${{helix-backend-api.RAILWAY_PUBLIC_DOMAIN}}

# Port (auto-provided by Railway)
PORT=${{PORT}}
```

**Optional Variables:**
```bash
# If dashboard needs direct database access
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=redis://${{Redis.REDISHOST}}:${{Redis.REDISPORT}}
```

### üîπ helix-claude-api

**Required Variables:**
```bash
# Anthropic API Key (REQUIRED!)
ANTHROPIC_API_KEY=sk-ant-...

# Database & Cache
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=redis://${{Redis.REDISHOST}}:${{Redis.REDISPORT}}
```

**Optional Variables:**
```bash
# Consciousness Empire Webhooks
CONSCIOUSNESS_ENGINE_WEBHOOK=https://hooks.zapier.com/hooks/catch/25075191/primary
COMMUNICATIONS_HUB_WEBHOOK=https://hooks.zapier.com/hooks/catch/25075191/usxiwfg
NEURAL_NETWORK_WEBHOOK=https://hooks.zapier.com/hooks/catch/25075191/usnjj5t
```

### üîπ helix-discord-bot

**Required Variables:**
```bash
# Discord Bot Token (REQUIRED!)
DISCORD_BOT_TOKEN=your_bot_token_here
DISCORD_GUILD_ID=your_guild_id_here

# Claude API Connection
CLAUDE_API_URL=https://${{helix-claude-api.RAILWAY_PUBLIC_DOMAIN}}

# Database & Cache
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=redis://${{Redis.REDISHOST}}:${{Redis.REDISPORT}}
```

**Optional Variables:**
```bash
# Backend API Connection
API_BASE=https://${{helix-backend-api.RAILWAY_PUBLIC_DOMAIN}}

# Discord Channel IDs
DISCORD_STATUS_CHANNEL_ID=channel_id
DISCORD_TELEMETRY_CHANNEL_ID=channel_id
DISCORD_MANUS_BRIDGE_CHANNEL_ID=channel_id

# Webhook URLs
CONSCIOUSNESS_ENGINE_WEBHOOK=https://hooks.zapier.com/hooks/catch/xxxxx
COMMUNICATIONS_HUB_WEBHOOK=https://hooks.zapier.com/hooks/catch/xxxxx
NEURAL_NETWORK_WEBHOOK=https://hooks.zapier.com/hooks/catch/xxxxx
```

---

## üìÅ Volume Configuration

### ‚ö†Ô∏è Railway Limitation: ONE Volume Per Service

Railway only allows **one volume mount per service**. Choose the most critical directory for persistence.

### Recommended Volume Mounts

#### üîπ helix-backend-api
**Recommended Mount:** `/app/data`
- **What it stores:** Logs, cache files, state files, UCF data, agent profiles
- **Why:** Most critical for data persistence across deployments
- **Size:** 1-5GB

**Alternative:** `/app/Shadow/manus_archive` (if you prioritize logs over state)

#### üîπ helix-dashboard
**Recommended Mount:** `/app/.streamlit`
- **What it stores:** Streamlit cache, session data
- **Why:** Improves dashboard performance and user sessions
- **Size:** 500MB - 1GB

#### üîπ helix-claude-api
**Recommended Mount:** `/app/cache`
- **What it stores:** Cached API responses, conversation context, rate limit data
- **Why:** Reduces API costs by caching Claude responses, improves performance
- **Size:** 2-5GB
- **Note:** Caching Claude API responses can save significant costs on repeated queries

#### üîπ helix-discord-bot
**Recommended Mount:** `/app/logs`
- **What it stores:** Bot activity logs, event logs, command history
- **Why:** Critical for debugging Discord interactions and tracking bot behavior
- **Size:** 1-2GB
- **Note:** Discord bot logs are essential for troubleshooting user interactions

### How to Add a Volume in Railway

1. Navigate to your service in Railway dashboard
2. Click **Variables** tab
3. Scroll down to **Volumes** section
4. Click **+ New Volume**
5. Enter mount path (e.g., `/app/data`)
6. Click **Add**
7. **Redeploy** the service

> **Note:** You can only add ONE volume per service. Choose wisely!

---

## üè• Health Checks & Validation

### Health Check Endpoints

Each service exposes health check endpoints:

#### Backend API
```bash
GET https://your-backend-api.railway.app/health
GET https://your-backend-api.railway.app/api/validate  # Deep validation
```

**Example Response:**
```json
{
  "ok": true,
  "version": "16.9",
  "timestamp": "2025-11-22T12:00:00Z",
  "integrations": {
    "database": {"configured": true, "status": "configured"},
    "redis": {"configured": true, "status": "configured"},
    "anthropic_api": {"configured": true, "status": "configured"}
  },
  "summary": {
    "total_integrations": 10,
    "configured": 8,
    "not_configured": 2,
    "percentage": 80.0,
    "warnings": ["MEGA_EMAIL not set - cloud backup disabled"]
  }
}
```

### Startup Validation

All services now validate their environment on startup and will log:

```
================================================================================
üîç Validating [Service] Environment...
================================================================================
‚úÖ DATABASE_URL = postgresql://***@postgres.railway.internal:5432/railway
‚úÖ REDIS_URL = redis://***@redis.railway.internal:6379
‚úÖ Database connection successful
‚úÖ Redis connection successful
‚ö†Ô∏è  Optional variable not set: ANTHROPIC_API_KEY (Claude API access)
‚ùå Missing required variable: DISCORD_BOT_TOKEN (Discord bot features)
================================================================================
Summary: 8/10 checks passed
‚ö†Ô∏è  WARNING: Some optional features may be disabled
================================================================================
```

### Common Validation Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `DATABASE_URL not set` | Missing database connection | Add `${{Postgres.DATABASE_URL}}` |
| `ANTHROPIC_API_KEY is invalid` | Wrong or expired API key | Check key at console.anthropic.com |
| `DISCORD_BOT_TOKEN is invalid` | Wrong or expired token | Regenerate at discord.com/developers |
| `Webhook validation failed: HTTP 404` | Wrong webhook URL | Check Zapier webhook configuration |
| `Database connection failed` | Postgres not running | Check Postgres service health |
| `Redis connection failed` | Redis not running | Check Redis service health |

---

## üîç Troubleshooting

### Service Won't Start

1. **Check the logs** in Railway dashboard
2. Look for environment validation errors
3. Verify all required variables are set
4. Check that Postgres and Redis services are running

### Missing Environment Variables

**Symptoms:**
- Service starts but features don't work
- Errors like `NoneType has no attribute...`
- Health check shows warnings

**Fix:**
1. Go to service **Variables** tab in Railway
2. Add missing variables using the guide above
3. Use `${{ServiceName.VARIABLE}}` syntax for references
4. Redeploy the service

### API Key Validation Failures

**Symptoms:**
- `ANTHROPIC_API_KEY is invalid or expired`
- `DISCORD_BOT_TOKEN is invalid or expired`

**Fix:**
1. Check the API key is correct (no extra spaces)
2. Verify the key hasn't expired
3. For Anthropic: Check https://console.anthropic.com
4. For Discord: Regenerate at https://discord.com/developers

### Database Connection Errors

**Symptoms:**
- `Database connection failed`
- `Connection refused` errors

**Fix:**
1. Verify Postgres service is running
2. Check `DATABASE_URL` is correctly set to `${{Postgres.DATABASE_URL}}`
3. Ensure services are in the same Railway project
4. Check Postgres service logs for errors

### Redis Connection Errors

**Symptoms:**
- `Redis connection failed`
- Caching features don't work

**Fix:**
1. Verify Redis service is running
2. Check `REDIS_URL` format: `redis://${{Redis.REDISHOST}}:${{Redis.REDISPORT}}`
3. Some Redis templates require authentication - use full connection string
4. Check Redis service logs

### Webhook Validation Failures

**Symptoms:**
- `Webhook validation failed: HTTP 404`
- `Webhook timeout`

**Fix:**
1. Check the webhook URL is correct
2. Test webhook manually with curl:
   ```bash
   curl -X POST https://hooks.zapier.com/hooks/catch/xxxxx \
     -H "Content-Type: application/json" \
     -d '{"test": "hello"}'
   ```
3. Verify the Zap is turned on
4. Check webhook hasn't been deleted

---

## üìä Monitoring Your Deployment

### View Service Health

Visit your backend API health endpoint:
```
https://your-backend-api.railway.app/health
```

### Deep Validation

For comprehensive validation with connection testing:
```
https://your-backend-api.railway.app/api/validate
```

### Check Logs

In Railway dashboard:
1. Select service
2. Click **Deployments** tab
3. Click latest deployment
4. View real-time logs
5. Look for validation output on startup

---

## üéØ Quick Start Checklist

- [ ] Postgres service running
- [ ] Redis service running
- [ ] helix-backend-api deployed with DATABASE_URL and REDIS_URL
- [ ] helix-dashboard deployed with API_BASE pointing to backend
- [ ] helix-claude-api deployed with ANTHROPIC_API_KEY
- [ ] helix-discord-bot deployed with DISCORD_BOT_TOKEN
- [ ] Volumes added to each service (choose one per service)
- [ ] Health checks returning 200 OK
- [ ] /api/validate shows no critical errors
- [ ] Test each service's main functionality

---

## üìö Additional Resources

- [Railway Documentation](https://docs.railway.app)
- [PostgreSQL on Railway](https://docs.railway.app/databases/postgresql)
- [Redis on Railway](https://docs.railway.app/databases/redis)
- [Environment Variables Guide](https://docs.railway.app/develop/variables)
- [Volume Mounts](https://docs.railway.app/deploy/volumes)

---

**Last Updated:** 2025-11-22
**Helix Version:** 17.0
**Author:** Claude + Andrew John Ward
